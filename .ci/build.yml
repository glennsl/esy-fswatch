parameters:
  host: ''
  pool: ''
  ESY__CACHE_INSTALL_PATH: ''

jobs:
- job: ${{ parameters.host }}
  pool: ${{ parameters.pool }}
  steps:
  - task: CacheBeta@0
    displayName: Cache esy on Windows
    inputs:
      key: |
        npm
        $(Agent.OS)
        esy@0.5.8
        $(Build.SourcesDirectory)/esy.lock/index.json
      path: C:\npm\prefix\node_modules
      condition: eq(variables['Agent.OS'], "Windows_NT")
  - template: ./use-esy.yml
  - task: CacheBeta@0
    inputs:
      key: |
        esy
        $(Agent.OS)
        ${{ parameters.ESY__CACHE_INSTALL_PATH }}
        $(Build.SourcesDirectory)/esy.lock/index.json
      path: ${{ parameters.ESY__CACHE_INSTALL_PATH }}
  - script: mkdir -p test_dir
    displayName: 'make test dir'
  - bash: |
      echo '{"dependencies": {"fswatch" : "ulrikstrid/esy-fswatch:package.json#'$(git rev-parse --short HEAD)'"}}' > package.json
    displayName: 'create test package.json'
    workingDirectory: test_dir
  - script: esy install
    displayName: 'Install esy-deps'
    workingDirectory: test_dir
  - script: esy build --verbose
    displayName: 'Build test project'
    workingDirectory: test_dir
    condition: ne(variables['Agent.OS'], "Windows_NT")
  - script: esy x fswatch --help
    displayName: 'Test if fswatch is installed'
    workingDirectory: test_dir
