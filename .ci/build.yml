parameters:
  host: ''
  pool: ''
  ESY__CACHE_INSTALL_PATH: ''

jobs:
- job: ${{ parameters.host }}
  pool: ${{ parameters.pool }}
  steps:
  - template: ./use-esy.yml
  - task: CacheBeta@0
    inputs:
      key: |
        esy
        $(Agent.OS)
        ${{ parameters.ESY__CACHE_INSTALL_PATH }}
        $(Build.SourcesDirectory)/esy.lock/index.json
      path: ${{ parameters.ESY__CACHE_INSTALL_PATH }}
  - script: mkdir -p test_dir
    displayName: 'make test dir'
  - bash: |
      echo '{"dependencies": {"@esy-packages/esy-fswatch" : "ulrikstrid/esy-fswatch:package.json#'$(git rev-parse --short HEAD)'"}}' > package.json
    displayName: 'create test package.json'
    workingDirectory: test_dir
  - script: esy install
    displayName: 'Install esy-deps'
    workingDirectory: test_dir
  - script: esy build
    displayName: 'Build esy-deps'
    workingDirectory: test_dir
  - script: esy x fswatch --help
    displayName: 'Test if fswatch is installed'
    workingDirectory: test_dir
